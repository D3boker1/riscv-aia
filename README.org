#+TITLE: Advanced Interrupt Architecture IP
#+AUTHOR: Francisco Marques
#+EMAIL: fmarques_00@protonmail.com
#+STARTUP: show2levels

* Disclaimer
This is a work in progress.

* About RISC-V AIA
Nowadays, the de facto interrupt controller in the RISC-V system is the Platform Level Interrupt Controller (PLIC). However, the PLIC specification, as it is, presents several limitations in terms of scalability and feature-richness. Among these limitations, we highlight: a large amount of physical address space used, and the sharing of M-mode and S-mode global registers, creating a possible security breach. The PLIC does not support interrupts through Message Signal Interrupts (MSI). Also, the Interrupt Request (IRQ) line sensing configuration is not allowed. Lastly, the PLIC does not provide any means to support virtualization.

In response to identified deficiencies in the PLIC, the RISC-V community has undertaken the development of a new interrupt controller specification. The RISC-V Advanced Interrupt Architecture (AIA) is the novel reference specification for interrupt-handling functionality. The specifications were recently ratified and are paving the way for integration in new RISC-V SoC designs.

AIA specification consists in:
1. An extension to the RISC-V privilege specification (Smaia and Ssaia);
2. Two standard interrupt controllers for RISC-V systems:
   a. Advanced Platform-Level Interrupt Controller (APLIC)
   b. Incoming Message-Signalled Interrupt Controller (IMSIC);
3. Requirements on other system components (e.g., IOMMU).

The Figure bellow shows the current interrupt controller model. It can be observed that wired sources are connected to the
PLIC, which for instance will be in charge of determining the interrupt prioritization and notify the CPU, by wire,
when an interrupt is available.

#+NAME: fig:PLIC-SoC
#+ATTR_LATEX: :width 200\textwidth
#+CAPTION: Current interrupt controller model.
[[./doc/PLIC-SoC.png]]

A SoC that implements the AIA specification will look like the Figure bellow. In scenarios where a platform opts not to incorporate an IMSIC, the absence of MSI channels results in the external interrupt controller responsibilities being assumed by the APLIC.

#+NAME: fig:AIA-SoC
#+ATTR_LATEX: :width 200\textwidth
#+CAPTION: AIA interrupt controller model.
[[./doc/AIA-SoC.png]]

* Repository Structure
** Documentation (doc)
In the [documentation](doc/README.md) folder you can find information about APLIC and IMSIC IPs. How to integrate IP into a RISC-V platform, the interfacing of the hardware blocks, and how they are made up.

** RTL
The rtl folder contains all the modules that make up each of the IPs.

** Tests
Under the tests folder, you can find unit tests of IPs intergration. The tests can easily be replicated by doing make inside the desired test.

* Tools and Versions
To run the test make sure you are using the right versions of cocotb and verilator. Currently cocotb only supports Verilator 4.106 (no earlier or later version).

|--------------------------------------------------+---------|
| Package/Tool                                     | Version |
|--------------------------------------------------+---------|
| (Cocotb)[https://www.cocotb.org/]                | 1.7.1   |
| (Verilator)[https://www.veripool.org/verilator/] | 4.106   |
| perl                                             | ---     |
| python3                                          | ---     |
| autoconf                                         | ---     |
| g++                                              | ---     |
| flex                                             | ---     |
| ccache                                           | ---     |
| bison                                            | 3.5.1   |
|--------------------------------------------------+---------|

* Status

|-------------+--------+-----------------------------------------------------------|
| AIA Module  | Status | Notes                                                     |
|-------------+--------+-----------------------------------------------------------|
| Smaia/Ssaia | WiP    | Major interrupts priority is not configurable in software |
| APLIC       | WiP    | Validated in the CVA6-based SoC                           |
| IMSIC       | WiP    | Validated in the CVA6-based SoC w/ M, S, and VS-files     |
|-------------+--------+-----------------------------------------------------------|
